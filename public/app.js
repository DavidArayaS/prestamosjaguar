const translations = {
  es: {
    navHome: 'Inicio',
    navExperience: 'Experiencia',
    navCoverage: 'Cobertura',
    navCalc: 'Calculadora',
    navForm: 'Solicitud',
    navFaq: 'FAQ',
    navTestimonials: 'Testimonios',
    heroKicker: 'Préstamos hipotecarios en Costa Rica',
    heroTitle: 'Préstamos sobre casas, lotes y propiedades comerciales',
    heroText:
      'Obtenga liquidez usando su casa, apartamento, lote o propiedad comercial como respaldo. Préstamos hipotecarios en Costa Rica con cobertura nacional, proceso legal y transparente. Respuesta inicial en un plazo máximo de 24 horas.',
    heroCtaApply: 'Solicitar evaluación',
    heroCtaCalc: 'Calcular cuota',
    heroPanelTitle: 'Datos clave',
    heroMetric1Label: 'Clientes atendidos',
    heroMetric1Value: '+500 operaciones en Costa Rica',
    heroMetric2Label: '¿A quién financiamos?',
    heroMetric2Value: 'Nacionales y extranjeros',
    heroMetric3Label: 'Destino del financiamiento',
    heroMetric3Value: 'Capital de trabajo, liquidez o inversión',
    heroMetric4Label: 'Ubicación de la propiedad',
    heroMetric4Value: 'Dentro y fuera del GAM',
    trustTitle1: '¿Qué propiedades aplican?',
    trustText1: 'Casas, apartamentos, lotes y propiedades comerciales inscritas, ubicadas en cualquier zona de Costa Rica.',
    trustTitle2: '¿Cómo funciona un préstamo hipotecario?',
    trustText2: 'Su propiedad se utiliza como garantía para acceder a financiamiento, con plazos y condiciones definidos según el valor del inmueble.',
    trustTitle3: 'Proceso claro y acompañado',
    trustText3: 'Le explicamos cada paso del proceso, sin letra pequeña ni sorpresas, desde la evaluación hasta la formalización.',
    calcProgress: 'Simulador para Costa Rica',
    calcTitle: '¿Cuánto necesitas?',
    calcText: 'Mueve el control para estimar tu cuota mensual.',
    calcMin: 'Mínimo',
    calcMax: 'Máximo',
    calcTermQuestion: 'Plazo base',
    calcApply: 'Aplicar con este monto',
    resultLabel: 'Cuota mensual estimada',
    rateNote: 'Cuota estimada de interés mensual.',
    resultDisclaimer: 'Esta calculadora es informativa y no sustituye una oferta formal.',
    termYears: 'años',
    formTitle: 'Solicitud de préstamo hipotecario',
    formText: 'Completa este formulario y enviaremos tu caso para evaluación. Te contactamos por teléfono.',
    fName: 'Nombre completo',
    fId: 'Número de cédula',
    fPhoneMain: 'Teléfono principal',
    fPhoneSec: 'Teléfono secundario',
    fEmail: 'Correo electrónico',
    fAmount: 'Cantidad solicitada',
    fPropertyType: 'Tipo de propiedad a hipotecar',
    fSelect: 'Seleccionar',
    fHouse: 'Casa',
    fApartment: 'Apartamento',
    fLand: 'Terreno',
    fCommercial: 'Comercial',
    fLandRecord: 'Número de finca o plano catastrado',
    fPropertySize: 'Tamaño de la propiedad (m²)',
    fFiscal: 'Valor fiscal de la propiedad',
    fFiscalMinPrefix: 'Mínimo recomendado:',
    fProvince: 'Provincia',
    fCanton: 'Cantón',
    fSelectProvince: 'Seleccionar provincia',
    fSelectCanton: 'Seleccionar cantón',
    currencyCRC: 'Colones (CRC)',
    currencyUSD: 'Dólares (USD)',
    formSubmit: 'Enviar solicitud',
    formSending: 'Enviando solicitud...',
    formSuccess: 'Solicitud enviada correctamente. Te contactaremos pronto.',
    formError: 'No se pudo enviar. Revisa los datos o la configuración del servidor.',
    captchaRequired: 'Completa el captcha para enviar la solicitud.',
    emailDomainError: 'Usa un correo válido de Gmail, Hotmail, Live, Outlook, Proton o Apple.',
    testTitle: 'Testimonios',
    testText: 'Experiencias reales frente a las trabas de la banca tradicional.',
    testGoto: 'Ir al testimonio'
  },
  en: {
    navHome: 'Home',
    navExperience: 'Experience',
    navCoverage: 'Coverage',
    navCalc: 'Calculator',
    navForm: 'Application',
    navFaq: 'FAQ',
    navTestimonials: 'Testimonials',
    heroKicker: 'Mortgage Loans in Costa Rica',
    heroTitle: 'Loans backed by residential and commercial properties',
    heroText:
      'Access capital using your house, apartment, land or commercial property as collateral. Mortgage loans in Costa Rica with nationwide coverage, a legal and transparent process. Initial evaluation within 24 hours.',
    heroCtaApply: 'Request evaluation',
    heroCtaCalc: 'Estimate payment',
    heroPanelTitle: 'Key data',
    heroMetric1Label: 'Clients served',
    heroMetric1Value: '500+ operations in Costa Rica',
    heroMetric2Label: 'Who we finance',
    heroMetric2Value: 'Nationals and foreigners',
    heroMetric3Label: 'Use of financing',
    heroMetric3Value: 'Working capital, liquidity or investment',
    heroMetric4Label: 'Property location',
    heroMetric4Value: 'Inside and outside the GAM',
    trustTitle1: 'Which properties qualify?',
    trustText1: 'Houses, apartments, land and commercial properties registered anywhere in Costa Rica.',
    trustTitle2: 'How does a mortgage-backed loan work?',
    trustText2: 'Your property is used as collateral to access financing, with terms defined by the property value.',
    trustTitle3: 'Clear guided process',
    trustText3: 'We explain every step with no fine print or surprises, from evaluation to formalization.',
    calcProgress: 'Costa Rica simulator',
    calcTitle: 'How much do you need?',
    calcText: 'Move the control to estimate your monthly payment.',
    calcMin: 'Minimum',
    calcMax: 'Maximum',
    calcTermQuestion: 'Base term',
    calcApply: 'Apply with this amount',
    resultLabel: 'Estimated monthly payment',
    rateNote: 'Estimated monthly interest payment.',
    resultDisclaimer: 'This calculator is informational and not a formal offer.',
    termYears: 'years',
    formTitle: 'Mortgage loan application',
    formText: 'Complete this form and we will send your case for review. We will contact you by phone.',
    fName: 'Full name',
    fId: 'ID number',
    fPhoneMain: 'Primary phone',
    fPhoneSec: 'Secondary phone',
    fEmail: 'Email address',
    fAmount: 'Requested amount',
    fPropertyType: 'Property type for collateral',
    fSelect: 'Select',
    fHouse: 'House',
    fApartment: 'Apartment',
    fLand: 'Land',
    fCommercial: 'Commercial',
    fLandRecord: 'Farm number or cadastral plan',
    fPropertySize: 'Property size (m²)',
    fFiscal: 'Fiscal property value',
    fFiscalMinPrefix: 'Suggested minimum:',
    fProvince: 'Province',
    fCanton: 'County',
    fSelectProvince: 'Select province',
    fSelectCanton: 'Select county',
    currencyCRC: 'Colones (CRC)',
    currencyUSD: 'Dollars (USD)',
    formSubmit: 'Send application',
    formSending: 'Sending application...',
    formSuccess: 'Application sent successfully. We will contact you soon.',
    formError: 'Could not send. Check data or server configuration.',
    captchaRequired: 'Please complete the captcha before submitting.',
    emailDomainError: 'Use a valid email from Gmail, Hotmail, Live, Outlook, Proton or Apple.',
    testTitle: 'Testimonials',
    testText: 'Real experiences dealing with traditional banking friction.',
    testGoto: 'Go to testimonial'
  },
  fr: {
    navHome: 'Accueil',
    navExperience: 'Expérience',
    navCoverage: 'Couverture',
    navCalc: 'Calculatrice',
    navForm: 'Demande',
    navFaq: 'FAQ',
    navTestimonials: 'Témoignages',
    heroKicker: 'Prêts hypothécaires au Costa Rica',
    heroTitle: 'Prêts garantis par maisons, terrains et biens commerciaux',
    heroText:
      'Obtenez des liquidités avec votre maison, appartement, terrain ou bien commercial comme garantie. Prêts hypothécaires au Costa Rica avec couverture nationale, processus légal et transparent. Évaluation initiale en 24 heures.',
    heroCtaApply: 'Demander une évaluation',
    heroCtaCalc: 'Calculer la mensualité',
    heroPanelTitle: 'Données clés',
    heroMetric1Label: 'Clients servis',
    heroMetric1Value: '500+ opérations au Costa Rica',
    heroMetric2Label: 'Qui finançons-nous',
    heroMetric2Value: 'Nationaux et étrangers',
    heroMetric3Label: 'Destination du financement',
    heroMetric3Value: 'Fonds de roulement, liquidité ou investissement',
    heroMetric4Label: 'Localisation de la propriété',
    heroMetric4Value: 'Dans et hors de la GAM',
    trustTitle1: 'Quelles propriétés sont éligibles ?',
    trustText1: 'Maisons, appartements, terrains et propriétés commerciales inscrites partout au Costa Rica.',
    trustTitle2: 'Comment fonctionne un prêt hypothécaire ?',
    trustText2: 'Votre propriété sert de garantie pour accéder au financement, avec des conditions selon la valeur du bien.',
    trustTitle3: 'Processus clair et accompagné',
    trustText3: 'Nous expliquons chaque étape, sans petites lignes, de l’évaluation à la formalisation.',
    calcProgress: 'Simulateur pour le Costa Rica',
    calcTitle: 'De combien avez-vous besoin ?',
    calcText: 'Déplacez le curseur pour estimer votre mensualité.',
    calcMin: 'Minimum',
    calcMax: 'Maximum',
    calcTermQuestion: 'Durée de base',
    calcApply: 'Demander avec ce montant',
    resultLabel: 'Mensualité estimée',
    rateNote: 'Mensualité estimée d’intérêt.',
    resultDisclaimer: 'Cette calculatrice est informative et ne constitue pas une offre formelle.',
    termYears: 'ans',
    formTitle: 'Demande de prêt hypothécaire',
    formText: 'Remplissez ce formulaire et nous évaluerons votre dossier. Nous vous contacterons par téléphone.',
    fName: 'Nom complet',
    fId: 'Numéro d’identité',
    fPhoneMain: 'Téléphone principal',
    fPhoneSec: 'Téléphone secondaire',
    fEmail: 'Courriel',
    fAmount: 'Montant demandé',
    fPropertyType: 'Type de propriété à hypothéquer',
    fSelect: 'Sélectionner',
    fHouse: 'Maison',
    fApartment: 'Appartement',
    fLand: 'Terrain',
    fCommercial: 'Commercial',
    fLandRecord: 'Numéro de propriété ou plan cadastral',
    fPropertySize: 'Surface de la propriété (m²)',
    fFiscal: 'Valeur fiscale de la propriété',
    fFiscalMinPrefix: 'Minimum recommandé :',
    fProvince: 'Province',
    fCanton: 'Canton',
    fSelectProvince: 'Sélectionner la province',
    fSelectCanton: 'Sélectionner le canton',
    currencyCRC: 'Colones (CRC)',
    currencyUSD: 'Dollars (USD)',
    formSubmit: 'Envoyer la demande',
    formSending: 'Envoi de la demande...',
    formSuccess: 'Demande envoyée correctement. Nous vous contacterons bientôt.',
    formError: 'Impossible d’envoyer. Vérifiez les données ou la configuration du serveur.',
    captchaRequired: 'Veuillez compléter le captcha avant d’envoyer.',
    emailDomainError: 'Utilisez un e-mail valide de Gmail, Hotmail, Live, Outlook, Proton ou Apple.',
    testTitle: 'Témoignages',
    testText: 'Expériences réelles face aux obstacles de la banque traditionnelle.',
    testGoto: 'Aller au témoignage'
  }
};

const provinceCantons = {
  'San José': [
    'San José', 'Escazú', 'Desamparados', 'Puriscal', 'Tarrazú', 'Aserrí', 'Mora', 'Goicoechea',
    'Santa Ana', 'Alajuelita', 'Vásquez de Coronado', 'Acosta', 'Tibás', 'Moravia', 'Montes de Oca',
    'Turrubares', 'Dota', 'Curridabat', 'Pérez Zeledón', 'León Cortés Castro'
  ],
  Alajuela: [
    'Alajuela', 'San Ramón', 'Grecia', 'San Mateo', 'Atenas', 'Naranjo', 'Palmares', 'Poás',
    'Orotina', 'San Carlos', 'Zarcero', 'Sarchí', 'Upala', 'Los Chiles', 'Guatuso', 'Río Cuarto'
  ],
  Cartago: ['Cartago', 'Paraíso', 'La Unión', 'Jiménez', 'Turrialba', 'Alvarado', 'Oreamuno', 'El Guarco'],
  Heredia: ['Heredia', 'Barva', 'Santo Domingo', 'Santa Bárbara', 'San Rafael', 'San Isidro', 'Belén', 'Flores', 'San Pablo', 'Sarapiquí'],
  Guanacaste: ['Liberia', 'Nicoya', 'Santa Cruz', 'Bagaces', 'Carrillo', 'Cañas', 'Abangares', 'Tilarán', 'Nandayure', 'La Cruz', 'Hojancha'],
  Puntarenas: ['Puntarenas', 'Esparza', 'Buenos Aires', 'Montes de Oro', 'Osa', 'Quepos', 'Golfito', 'Coto Brus', 'Parrita', 'Corredores', 'Garabito', 'Monteverde', 'Puerto Jiménez'],
  Limón: ['Limón', 'Pococí', 'Siquirres', 'Talamanca', 'Matina', 'Guácimo']
};

const testimonials = {
  es: [
    {
      text: 'Necesitaba liquidez para ordenar compromisos financieros y no encontraba una solución clara. Utilicé mi casa como garantía y en menos de 24 horas recibí una respuesta concreta. El proceso fue transparente y siempre supe en qué etapa estaba.',
      name: 'Carlos M. - Heredia (persona física / casa)'
    },
    {
      text: 'Quería aprovechar una oportunidad de inversión y necesitaba una solución rápida. Usé un apartamento como respaldo y la evaluación fue muy ordenada y profesional. Todo quedó claro desde el inicio.',
      name: 'Mariana P. - Cartago (persona física / apartamento)'
    },
    {
      text: 'Pensé que por estar fuera del GAM iba a ser complicado, pero no fue así. Presenté un lote como garantía y recibí acompañamiento en todo momento. La claridad del proceso marcó la diferencia.',
      name: 'José A. - Guanacaste (persona física / lote, fuera del GAM)'
    },
    {
      text: 'Buscábamos capital de trabajo para el negocio y utilizamos una propiedad comercial como respaldo. Nos explicaron todo desde el inicio y el proceso fue mucho más ágil de lo esperado. Fue clave poder avanzar sin frenar la operación.',
      name: 'Laura R. - San José (persona física / propiedad comercial)'
    },
    {
      text: 'Necesitábamos liquidez para sostener inventario y operación sin frenar el crecimiento. Utilizamos una propiedad comercial como garantía y recibimos una respuesta clara en muy poco tiempo. El proceso fue ordenado y con acompañamiento real desde el inicio.',
      name: 'Casalinda Mobiliario - San José (empresa / propiedad comercial)'
    },
    {
      text: 'Buscábamos una solución de financiamiento para reorganizar flujos del negocio. Presentamos una propiedad como respaldo y el proceso fue transparente y bien explicado. Poder avanzar con claridad marcó una diferencia importante para la empresa.',
      name: 'Artífice Modulor - Cartago (empresa / inmueble productivo)'
    }
  ],
  en: [
    {
      text: 'I needed liquidity to reorganize financial commitments and could not find a clear option. I used my house as collateral and got a concrete response in less than 24 hours. The process was transparent and I always knew the stage of my case.',
      name: 'Carlos M. - Heredia (individual / house)'
    },
    {
      text: 'I wanted to act on an investment opportunity and needed a fast solution. I used an apartment as collateral and the evaluation was very professional and structured. Everything was clear from day one.',
      name: 'Mariana P. - Cartago (individual / apartment)'
    },
    {
      text: 'I thought being outside the GAM would make everything difficult, but it was not. I submitted a land lot as collateral and received support throughout the process. The clarity made all the difference.',
      name: 'José A. - Guanacaste (individual / land lot, outside GAM)'
    },
    {
      text: 'We needed working capital for our business and used a commercial property as collateral. Everything was explained from the beginning and the process was faster than expected. It helped us move forward without stopping operations.',
      name: 'Laura R. - San José (individual / commercial property)'
    },
    {
      text: 'We needed liquidity to sustain inventory and operations without slowing growth. We used a commercial property as collateral and got a clear response very quickly. The process was orderly with real support from the start.',
      name: 'Casalinda Mobiliario - San José (company / commercial property)'
    },
    {
      text: 'We needed financing to reorganize business cash flow. We presented a property as collateral and the process was transparent and clearly explained. Moving forward with certainty made an important difference for the company.',
      name: 'Artífice Modulor - Cartago (company / productive property)'
    }
  ],
  fr: [
    {
      text: 'J’avais besoin de liquidités pour organiser mes engagements financiers et je ne trouvais pas de solution claire. J’ai utilisé ma maison comme garantie et j’ai reçu une réponse concrète en moins de 24 heures. Le processus a été transparent à chaque étape.',
      name: 'Carlos M. - Heredia (personne physique / maison)'
    },
    {
      text: 'Je voulais saisir une opportunité d’investissement et j’avais besoin d’une solution rapide. J’ai utilisé un appartement comme garantie et l’évaluation a été très professionnelle et ordonnée. Tout était clair dès le départ.',
      name: 'Mariana P. - Cartago (personne physique / appartement)'
    },
    {
      text: 'Je pensais que le fait d’être hors du GAM compliquerait tout, mais ce ne fut pas le cas. J’ai présenté un terrain comme garantie et j’ai été accompagné tout au long du processus. La clarté a fait la différence.',
      name: 'José A. - Guanacaste (personne physique / terrain, hors GAM)'
    },
    {
      text: 'Nous avions besoin de fonds de roulement pour l’entreprise et nous avons utilisé une propriété commerciale comme garantie. Tout a été expliqué dès le début et le processus a été plus rapide que prévu. Cela nous a permis d’avancer sans freiner l’activité.',
      name: 'Laura R. - San José (personne physique / propriété commerciale)'
    },
    {
      text: 'Nous avions besoin de liquidités pour soutenir l’inventaire et l’opération sans freiner la croissance. Nous avons utilisé une propriété commerciale comme garantie et obtenu une réponse claire en très peu de temps. Le processus a été structuré avec un accompagnement réel.',
      name: 'Casalinda Mobiliario - San José (entreprise / propriété commerciale)'
    },
    {
      text: 'Nous cherchions un financement pour réorganiser les flux de l’entreprise. Nous avons présenté une propriété comme garantie et le processus a été transparent et bien expliqué. Avancer avec clarté a fait une différence importante pour l’entreprise.',
      name: 'Artífice Modulor - Cartago (entreprise / actif productif)'
    }
  ]
};

const currencyConfig = {
  CRC: { min: 10000000, max: 50000000, step: 250000, locale: 'es-CR' },
  USD: { min: 20000, max: 100000, step: 500, locale: 'en-US' }
};
const formAmountConfig = {
  CRC: { min: 10000000, max: 100000000, step: 1 },
  USD: { min: 20000, max: 200000, step: 1 }
};
const allowedEmailDomains = new Set([
  'gmail.com',
  'googlemail.com',
  'hotmail.com',
  'outlook.com',
  'live.com',
  'proton.me',
  'protonmail.com',
  'icloud.com',
  'me.com',
  'mac.com'
]);

const monthlyInterestRate = 0.0125;

let currentLang = 'es';
let currentCurrency = 'CRC';
const selectedYears = 2;
let currentTestimonialIndex = 0;
let carouselTimer = null;
let captchaEnabled = false;
let captchaWidgetId = null;

const yearEl = document.getElementById('year');
const langSelect = document.getElementById('langSelect');
const track = document.getElementById('testimonialTrack');
const dots = document.getElementById('testimonialDots');
const prevBtn = document.getElementById('testPrev');
const nextBtn = document.getElementById('testNext');
const form = document.getElementById('loanForm');
const formStatus = document.getElementById('formStatus');
const provinciaSelect = document.getElementById('provinciaSelect');
const cantonSelect = document.getElementById('cantonSelect');
const captchaContainer = document.getElementById('captchaContainer');
const captchaTokenInput = document.getElementById('captchaToken');

const calcRange = document.getElementById('calcRange');
const calcAmountLabel = document.getElementById('calcAmountLabel');
const calcAmountValue = document.getElementById('calcAmountValue');
const rangeMin = document.getElementById('rangeMin');
const rangeMax = document.getElementById('rangeMax');
const currencyButtons = document.querySelectorAll('.currency-btn');
const monthlyResult = document.getElementById('monthlyResult');

function formatCurrency(amount, currency) {
  const locale = currencyConfig[currency].locale;
  return new Intl.NumberFormat(locale, {
    style: 'currency',
    currency,
    maximumFractionDigits: currency === 'CRC' ? 0 : 2
  }).format(amount);
}

function formatThousandsDots(value) {
  const safe = Math.max(0, Math.round(Number(value) || 0));
  return new Intl.NumberFormat('de-DE', { maximumFractionDigits: 0 }).format(safe);
}

function parseAmountInput(raw) {
  const digitsOnly = String(raw || '').replace(/\D/g, '');
  return digitsOnly ? Number(digitsOnly) : NaN;
}

function applyAmountUiLimits(input, currency) {
  const config = formAmountConfig[currency];
  if (!config) return;
  const maxLen = formatThousandsDots(config.max).length;
  input.maxLength = maxLen;
  input.placeholder = currency === 'CRC' ? '10.000.000' : '20.000';
}

function formatCurrencyDots(amount, currency) {
  const symbol = currency === 'CRC' ? '₡' : '$';
  return `${symbol}${formatThousandsDots(amount)}`;
}

function setRangeForCurrency(nextCurrency) {
  const config = currencyConfig[nextCurrency];
  calcRange.min = String(config.min);
  calcRange.max = String(config.max);
  calcRange.step = String(config.step);
  calcRange.value = String(config.min);
  rangeMin.textContent = formatCurrency(config.min, nextCurrency);
  rangeMax.textContent = formatCurrency(config.max, nextCurrency);
  calcAmountLabel.textContent = nextCurrency === 'CRC' ? '₡' : '$';
}

function calculateLoan() {
  const principal = Number(calcRange.value);
  const monthlyPayment = principal * monthlyInterestRate;
  calcAmountValue.textContent = new Intl.NumberFormat(currencyConfig[currentCurrency].locale, {
    maximumFractionDigits: currentCurrency === 'CRC' ? 0 : 2
  }).format(principal);
  monthlyResult.textContent = formatCurrency(monthlyPayment, currentCurrency);
}

function renderTestimonials() {
  const items = testimonials[currentLang];
  if (!items || !items.length) return;
  if (currentTestimonialIndex >= items.length) currentTestimonialIndex = 0;

  const item = items[currentTestimonialIndex];
  track.innerHTML = `<article class="testimonial-card slide-in-rtl"><p>"${item.text}"</p><strong>${item.name}</strong></article>`;

  dots.innerHTML = '';
  items.forEach((_, index) => {
    const dot = document.createElement('button');
    dot.type = 'button';
    dot.className = `dot ${index === currentTestimonialIndex ? 'active' : ''}`;
    dot.setAttribute('aria-label', `${translations[currentLang].testGoto} ${index + 1}`);
    dot.addEventListener('click', () => {
      currentTestimonialIndex = index;
      renderTestimonials();
      restartCarouselTimer();
    });
    dots.appendChild(dot);
  });
}

function nextTestimonial(step = 1) {
  const items = testimonials[currentLang];
  currentTestimonialIndex = (currentTestimonialIndex + step + items.length) % items.length;
  renderTestimonials();
}

function startCarouselTimer() {
  stopCarouselTimer();
  carouselTimer = setInterval(() => nextTestimonial(1), 8000);
}

function stopCarouselTimer() {
  if (carouselTimer) clearInterval(carouselTimer);
  carouselTimer = null;
}

function restartCarouselTimer() {
  startCarouselTimer();
}

function setCaptchaToken(token) {
  if (captchaTokenInput) captchaTokenInput.value = token || '';
}

function renderCaptcha(siteKey) {
  if (!captchaContainer || !window.turnstile || !siteKey) return false;
  if (captchaWidgetId !== null) {
    try {
      window.turnstile.remove(captchaWidgetId);
    } catch (_error) {
      // ignore
    }
    captchaWidgetId = null;
  }
  setCaptchaToken('');
  captchaWidgetId = window.turnstile.render('#captchaContainer', {
    sitekey: siteKey,
    theme: 'light',
    callback: (token) => setCaptchaToken(token),
    'expired-callback': () => setCaptchaToken(''),
    'error-callback': () => setCaptchaToken('')
  });
  return true;
}

function renderCaptchaWhenReady(siteKey, attempt = 0) {
  if (!captchaEnabled) return;
  if (renderCaptcha(siteKey)) return;
  if (attempt < 40) setTimeout(() => renderCaptchaWhenReady(siteKey, attempt + 1), 250);
}

async function initCaptchaConfig() {
  if (!captchaContainer) return;
  try {
    const res = await fetch('/api/public-config');
    if (!res.ok) throw new Error('config');
    const data = await res.json();
    captchaEnabled = Boolean(data.captchaEnabled && data.turnstileSiteKey);
    if (!captchaEnabled) {
      captchaContainer.style.display = 'none';
      return;
    }
    captchaContainer.style.display = '';
    renderCaptchaWhenReady(data.turnstileSiteKey);
  } catch (_error) {
    captchaEnabled = false;
    captchaContainer.style.display = 'none';
  }
}

function refreshTermLabels() {
  const termPill = document.querySelector('.term-pill');
  if (!termPill) return;
  termPill.textContent = `${selectedYears} ${translations[currentLang].termYears}`;
}

function sanitizeDigits(input, maxLen) {
  input.addEventListener('input', () => {
    const onlyDigits = input.value.replace(/\D/g, '').slice(0, maxLen);
    input.value = onlyDigits;
  });
}

function validateEmailDomain() {
  const emailInput = form.elements.correo;
  if (!emailInput) return true;
  const value = String(emailInput.value || '').trim().toLowerCase();
  const at = value.lastIndexOf('@');
  if (at <= 0 || at === value.length - 1) {
    emailInput.setCustomValidity('');
    return true;
  }
  const domain = value.slice(at + 1);
  const ok = allowedEmailDomains.has(domain);
  emailInput.setCustomValidity(ok ? '' : translations[currentLang].emailDomainError);
  return ok;
}

function validateLoanAmountRange() {
  const amountInput = form.elements.montoPrestamo;
  const amountCurrency = form.elements.monedaMontoPrestamo;
  if (!amountInput || !amountCurrency) return true;

  const raw = String(amountInput.value || '').trim();
  if (!raw) {
    amountInput.setCustomValidity('');
    return false;
  }

  const amount = parseAmountInput(raw);
  const config = formAmountConfig[amountCurrency.value];
  if (!Number.isFinite(amount) || !config) {
    amountInput.setCustomValidity('');
    return false;
  }

  const valid = amount >= config.min && amount <= config.max;
  let message = '';
  if (amount > config.max) {
    message =
      currentLang === 'es'
        ? `Ingresa un monto menor al máximo permitido (${formatCurrencyDots(config.max, amountCurrency.value)}).`
        : currentLang === 'fr'
          ? `Entrez un montant inférieur au maximum autorisé (${formatCurrencyDots(config.max, amountCurrency.value)}).`
          : `Enter an amount lower than the maximum allowed (${formatCurrencyDots(config.max, amountCurrency.value)}).`;
  } else if (amount < config.min) {
    message =
      currentLang === 'es'
        ? `El monto mínimo permitido es ${formatCurrencyDots(config.min, amountCurrency.value)}.`
        : currentLang === 'fr'
          ? `Le montant minimum autorisé est ${formatCurrencyDots(config.min, amountCurrency.value)}.`
          : `The minimum allowed amount is ${formatCurrencyDots(config.min, amountCurrency.value)}.`;
  }

  amountInput.setCustomValidity(valid ? '' : message);
  return valid;
}

function normalizeLoanAmountInput() {
  const amountInput = form.elements.montoPrestamo;
  const amountCurrency = form.elements.monedaMontoPrestamo;
  if (!amountInput || !amountCurrency) return NaN;

  const config = formAmountConfig[amountCurrency.value];
  if (!config) return NaN;

  const maxDigits = String(config.max).length;
  const cleanedRaw = String(amountInput.value || '').replace(/\D/g, '');
  const cleaned = cleanedRaw.slice(0, maxDigits);
  if (!cleaned) {
    amountInput.value = '';
    return NaN;
  }

  let normalized = Number(cleaned);
  if (!Number.isFinite(normalized)) normalized = config.max;
  if (normalized > config.max) normalized = config.max;
  amountInput.value = formatThousandsDots(normalized);
  return normalized;
}

function applyMoneyBounds(input, select) {
  const config = formAmountConfig[select.value];
  input.dataset.min = String(config.min);
  input.dataset.max = String(config.max);
  input.dataset.step = String(config.step);
  applyAmountUiLimits(input, select.value);
  const val = parseAmountInput(input.value);
  if (!Number.isFinite(val)) {
    input.value = formatThousandsDots(config.min);
  } else {
    input.value = formatThousandsDots(Math.min(val, config.max));
  }
  validateLoanAmountRange();
}

function setupFormCurrencyFields() {
  const amountInput = form.elements.montoPrestamo;
  const amountCurrency = form.elements.monedaMontoPrestamo;
  if (amountInput && amountCurrency) {
    applyMoneyBounds(amountInput, amountCurrency);
    if (!amountCurrency.dataset.boundAmountCurrency) {
      amountCurrency.addEventListener('change', () => {
        applyAmountUiLimits(amountInput, amountCurrency.value);
        applyMoneyBounds(amountInput, amountCurrency);
        amountInput.value = formatThousandsDots(formAmountConfig[amountCurrency.value].min);
        const fiscalCurrency = form.elements.monedaValorFiscal;
        if (fiscalCurrency) fiscalCurrency.value = amountCurrency.value;
        validateLoanAmountRange();
        validateFiscalVsLoan();
        updateMoneyPreviews();
      });
      amountCurrency.dataset.boundAmountCurrency = '1';
    }
    if (!amountInput.dataset.boundAmountInput) {
      amountInput.addEventListener('input', () => {
        normalizeLoanAmountInput();
        validateLoanAmountRange();
      });
      amountInput.addEventListener('change', () => {
        normalizeLoanAmountInput();
        validateLoanAmountRange();
      });
      amountInput.addEventListener('paste', () => {
        requestAnimationFrame(() => {
          normalizeLoanAmountInput();
          validateLoanAmountRange();
        });
      });
      amountInput.dataset.boundAmountInput = '1';
    }
  }

  const fiscalInput = form.elements.valorFiscal;
  const fiscalCurrency = form.elements.monedaValorFiscal;
  if (fiscalInput && fiscalCurrency) {
    fiscalInput.min = '0';
    fiscalInput.step = '1';
    if (fiscalInput.value === '') fiscalInput.value = '0';
    if (amountCurrency) fiscalCurrency.value = amountCurrency.value;
  }
}

function setDefaultCurrencySelection() {
  currentCurrency = 'CRC';
  currencyButtons.forEach((btn) => {
    btn.classList.toggle('active', btn.dataset.currency === 'CRC');
  });
}

function toCrc(amount, currency) {
  return currency === 'USD' ? amount * 525 : amount;
}

function updateMoneyPreviews() {
  const amountInput = form.elements.montoPrestamo;
  const amountCurrency = form.elements.monedaMontoPrestamo;
  const amountPreview = document.getElementById('montoPreview');
  if (amountInput && amountCurrency && amountPreview) {
    amountPreview.textContent = formatCurrencyDots(parseAmountInput(amountInput.value) || 0, amountCurrency.value);
  }

  const fiscalInput = form.elements.valorFiscal;
  const fiscalCurrency = form.elements.monedaValorFiscal;
  const fiscalPreview = document.getElementById('fiscalPreview');
  if (fiscalInput && fiscalCurrency && fiscalPreview) {
    fiscalPreview.textContent = formatCurrencyDots(Number(fiscalInput.value) || 0, fiscalCurrency.value);
  }
}

function validateFiscalVsLoan() {
  const amountInput = form.elements.montoPrestamo;
  const amountCurrency = form.elements.monedaMontoPrestamo;
  const fiscalInput = form.elements.valorFiscal;
  const fiscalCurrency = form.elements.monedaValorFiscal;
  if (!amountInput || !amountCurrency || !fiscalInput || !fiscalCurrency) return true;

  const loan = parseAmountInput(amountInput.value);
  const fiscal = Number(fiscalInput.value);
  if (!Number.isFinite(loan) || !Number.isFinite(fiscal)) return true;

  const minimumCrc = toCrc(loan, amountCurrency.value) * 1.5;
  const fiscalCrc = toCrc(fiscal, fiscalCurrency.value);
  const valid = fiscalCrc >= minimumCrc;

  const minimumInLoanCurrency = amountCurrency.value === 'USD' ? minimumCrc / 525 : minimumCrc;
  const hint = document.getElementById('fiscalMinHint');
  if (hint) hint.textContent = formatCurrencyDots(minimumInLoanCurrency, amountCurrency.value);

  fiscalInput.setCustomValidity(
    valid
      ? ''
      : currentLang === 'es'
        ? 'El valor fiscal debe ser al menos 50% mayor al monto solicitado.'
        : currentLang === 'fr'
          ? 'La valeur fiscale doit être au moins 50% supérieure au montant demandé.'
          : 'Fiscal value must be at least 50% higher than requested amount.'
  );

  updateMoneyPreviews();
  return valid;
}

function populateProvinces() {
  const selected = provinciaSelect.value;
  provinciaSelect.innerHTML = '';

  const defaultOption = document.createElement('option');
  defaultOption.value = '';
  defaultOption.textContent = translations[currentLang].fSelectProvince;
  provinciaSelect.appendChild(defaultOption);

  Object.keys(provinceCantons).forEach((province) => {
    const option = document.createElement('option');
    option.value = province;
    option.textContent = province;
    if (selected === province) option.selected = true;
    provinciaSelect.appendChild(option);
  });
}

function populateCantons(province, selected = '') {
  cantonSelect.innerHTML = '';

  const defaultOption = document.createElement('option');
  defaultOption.value = '';
  defaultOption.textContent = translations[currentLang].fSelectCanton;
  cantonSelect.appendChild(defaultOption);

  const cantons = provinceCantons[province] || [];
  cantons.forEach((canton) => {
    const option = document.createElement('option');
    option.value = canton;
    option.textContent = canton;
    if (selected === canton) option.selected = true;
    cantonSelect.appendChild(option);
  });
}

function cacheDefaultI18nText() {
  document.querySelectorAll('[data-i18n]').forEach((el) => {
    if (typeof el.dataset.i18nDefault === 'undefined') {
      el.dataset.i18nDefault = el.textContent;
    }
  });
}

function applyTranslations() {
  document.documentElement.lang = currentLang;

  document.querySelectorAll('[data-i18n]').forEach((el) => {
    const key = el.getAttribute('data-i18n');
    if (currentLang === 'es') {
      if (typeof el.dataset.i18nDefault !== 'undefined') {
        el.textContent = el.dataset.i18nDefault;
      }
      return;
    }
    const text = translations[currentLang][key];
    if (typeof text !== 'undefined') el.textContent = text;
  });

  langSelect.value = currentLang;
  refreshTermLabels();
  populateProvinces();
  populateCantons(provinciaSelect.value, cantonSelect.value);
  renderTestimonials();
  calculateLoan();
  validateFiscalVsLoan();
  validateLoanAmountRange();
  validateEmailDomain();
}

langSelect.addEventListener('change', () => {
  currentLang = langSelect.value;
  applyTranslations();
});

provinciaSelect.addEventListener('change', () => {
  populateCantons(provinciaSelect.value);
});

currencyButtons.forEach((button) => {
  button.addEventListener('click', () => {
    const nextCurrency = button.dataset.currency;
    if (nextCurrency === currentCurrency) return;
    currencyButtons.forEach((btn) => btn.classList.remove('active'));
    button.classList.add('active');
    currentCurrency = nextCurrency;
    setRangeForCurrency(currentCurrency);
    calculateLoan();
  });
});

calcRange.addEventListener('input', calculateLoan);

['montoPrestamo', 'monedaMontoPrestamo', 'valorFiscal', 'monedaValorFiscal'].forEach((name) => {
  const field = form.elements[name];
  if (!field) return;
  field.addEventListener('input', () => {
    validateFiscalVsLoan();
    updateMoneyPreviews();
  });
  field.addEventListener('change', () => {
    validateFiscalVsLoan();
    updateMoneyPreviews();
  });
});

sanitizeDigits(form.elements.cedula, 11);
sanitizeDigits(form.elements.telefonoPrincipal, 8);
sanitizeDigits(form.elements.telefonoSecundario, 8);
if (form.elements.correo) {
  form.elements.correo.addEventListener('input', validateEmailDomain);
  form.elements.correo.addEventListener('change', validateEmailDomain);
}

if (prevBtn) {
  prevBtn.addEventListener('click', () => {
    nextTestimonial(-1);
    restartCarouselTimer();
  });
}

if (nextBtn) {
  nextBtn.addEventListener('click', () => {
    nextTestimonial(1);
    restartCarouselTimer();
  });
}

form.addEventListener('submit', async (e) => {
  e.preventDefault();
  if (captchaEnabled) {
    const token = String(captchaTokenInput?.value || '').trim();
    if (!token) {
      formStatus.className = 'full form-status error';
      formStatus.textContent = translations[currentLang].captchaRequired;
      return;
    }
  }
  const loanOk = validateLoanAmountRange();
  const fiscalOk = validateFiscalVsLoan();
  const emailOk = validateEmailDomain();
  if (!loanOk || !fiscalOk || !emailOk || !form.reportValidity()) return;

  formStatus.className = 'full form-status';
  formStatus.textContent = translations[currentLang].formSending;

  const formData = new FormData(form);
  const payload = Object.fromEntries(formData.entries());
  payload.montoPrestamo = String(parseAmountInput(payload.montoPrestamo));

  try {
    const res = await fetch('/api/solicitud', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    const data = await res.json();
    if (!res.ok || !data.ok) throw new Error(data.message || 'Error');

    formStatus.classList.add('ok');
    formStatus.textContent = translations[currentLang].formSuccess;
    form.reset();
    setupFormCurrencyFields();
    populateCantons('');
    updateMoneyPreviews();
    setCaptchaToken('');
    if (captchaEnabled && window.turnstile && captchaWidgetId !== null) {
      try {
        window.turnstile.reset(captchaWidgetId);
      } catch (_error) {
        // ignore
      }
    }
  } catch (error) {
    formStatus.classList.add('error');
    formStatus.textContent = `${translations[currentLang].formError} (${error.message})`;
    if (captchaEnabled && window.turnstile && captchaWidgetId !== null) {
      try {
        window.turnstile.reset(captchaWidgetId);
      } catch (_error) {
        // ignore
      }
    }
  }
});

function resetUiState() {
  form.reset();
  formStatus.className = 'full form-status';
  formStatus.textContent = '';
  if (form.elements.correo) form.elements.correo.setCustomValidity('');
  provinciaSelect.value = '';
  setDefaultCurrencySelection();
  setRangeForCurrency(currentCurrency);
  setupFormCurrencyFields();
  populateCantons('');
  currentTestimonialIndex = 0;
  setCaptchaToken('');
  if (captchaEnabled && window.turnstile && captchaWidgetId !== null) {
    try {
      window.turnstile.reset(captchaWidgetId);
    } catch (_error) {
      // ignore
    }
  }
  updateMoneyPreviews();
  validateFiscalVsLoan();
  calculateLoan();
}

window.addEventListener('pageshow', () => {
  resetUiState();
});

yearEl.textContent = new Date().getFullYear();
cacheDefaultI18nText();
populateProvinces();
initCaptchaConfig();
applyTranslations();
resetUiState();
startCarouselTimer();
